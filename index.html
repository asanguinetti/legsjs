<!DOCTYPE html>

<html>

<head>
  <title>Creature Demo - Axel Sanguinetti</title>
  
  <script type="text/javascript" src="js/node_dummy.js"></script>
  <script type="text/javascript" src="js/three.js"></script>
  <script type="text/javascript" src="js/ammo.js"></script>
  <script type="text/javascript" src="js/demo_utils.js"></script>
  <script type="text/javascript" src="js/skeletal_figure.js"></script>
  <script type="text/javascript" src="js/bodies.js"></script>
  <script type="text/javascript" src="js/skeletal_quadruped.js"></script>
  <script type="text/javascript" src="js/log.js"></script>
  
  <script type="text/javascript">
  
  'use strict';
  
  var initScene = function() {
    var demo = new Demo(document.getElementById('viewport'));
    var logger = new NullLogger();

    /* ground */
    var ground = new Ground(new THREE.Vector3(500, 500, 0.5));
    ground.buildAndInsert(demo.scene);

    var skeletalFigure = SkeletalFigure.SkeletalSegment.fromJSON(SkeletalQuadruped);

    /* trunk */
    var trunk = skeletalFigure.body;
    trunk.translate(0, 0, 5.4 + trunk.size.z + 0.5);
    trunk.buildAndInsert(demo.scene);
    demo.scene.camera.target = trunk;

    var controlParams = {
      legFrame: {
        torqueLimit: 1000,
        pdGains: [6000, 1200],
        fbGains: [0, 0]
      },
      joints: [
        {
          torqueLimit: 1000,
          pdGains: [1500, 300],
          fbGains: [0.16, 0.16]
        },
        {
          torqueLimit: 1000,
          pdGains: [1500, 300],
          fbGains: [0, 0]
        },
        {
          torqueLimit: 1000,
          pdGains: [1500, 300],
          fbGains: [0, 0]
        }
      ]
    }

    var legFrames = [];
    for(var i = 0; i < skeletalFigure.childrenJoints.length; i++)
    {
      /* FIXME: shouldn't have to do all this manually */
      var skJoint = skeletalFigure.childrenJoints[i];
      var rootSeg = skJoint.childSegment;
      rootSeg.body.snapTo((new THREE.Vector3()).fromArray(skJoint.snapPointChild),
                          skJoint.parentSegment.body,
                          (new THREE.Vector3()).fromArray(skJoint.snapPointParent));
      var legFrame = new LegFrame(new WalkingGait(), rootSeg, controlParams);
      legFrame.buildAndInsert(demo.scene);
      legFrames.push(legFrame);

      var joint = new Joint(skJoint, controlParams.joints[0], 
                            new THREE.Vector3(1, -0.1, -0.1),
                            new THREE.Vector3(0, 0.1, 0.1),
                            false);
      joint.buildAndInsert(demo.scene);
    }

    /* sets a callback for updating the torques on the joints */
    var fp = Ammo.Runtime.addFunction(function(world, timeStep) {
      demo.scene.world.clearForces();
      demo.scene.world.bodies.forEach(function(b) {
        b.body.applyGravity();
      });

      /* iterates over the contact manifolds to check if any leg is touching the ground */
      var numManifolds = demo.scene.world.getDispatcher().getNumManifolds();
      for(var i = 0; i < numManifolds; i++) {
          var contactManifold =  demo.scene.world.getDispatcher().getManifoldByIndexInternal(i);
          var obA = contactManifold.getBody0();
          var obB = contactManifold.getBody1();
          var legSegment;

          /* finds if any of the two objects is the ground */
          if(Ammo.compare(obA, ground.body))
            legSegment = obB;
          else if(Ammo.compare(obB, ground.body))
            legSegment = obA;
          else
            continue;

          /* finds if any of the feet is the other object */
          legFrames.forEach(function(legFrame) {
            for(var j = 0; j < legFrame.legs.length; j++) {
              var leg = legFrame.legs[j];
              if(Ammo.compare(leg.segments[leg.segments.length - 1].body, legSegment))
              {
                legFrame.gait.setContactForLeg(j, true);
                break;
              }
            }
          });
      }

      legFrames.forEach(function(legFrame) {
        legFrame.update(timeStep);

        for(var i = 0; i < legFrame.legs.length; i++) {
          legFrame.gait.setContactForLeg(i, false);
        }
      });
    });

    demo.scene.world.setInternalTickCallback(fp, undefined, true);

    demo.animate();
  };

  window.onload = initScene;
  
  </script>
</head>

<body>
  <div id="viewport"></div>
</body>

</html>